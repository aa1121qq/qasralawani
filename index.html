<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>تحديد المدينة والحي</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    #map { height: 400px; display:none; margin-bottom: 15px;}
    #overlay { position: fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); display:none; z-index: 1000;}
    #popup { background:white; padding:20px; border-radius:10px; width:450px; margin:80px auto; position:relative;}
    .field { margin: 8px 0; }
    .btn { padding:10px 20px; background:#2e8b57; color:white; border:none; border-radius:5px; cursor:pointer; }
  </style>
</head>
<body dir="rtl">

<h2>تحديد المدينة والحي تلقائيًا</h2>
<div class="field">
  <label>اسم المدينة:</label>
  <input id="city" type="text" readonly>
</div>
<div class="field">
  <label>اسم الحي:</label>
  <input id="district" type="text" readonly>
</div>
<button class="btn" onclick="openMap()">حدد موقعك على الخريطة</button>

<div id="overlay">
  <div id="popup">
    <h3>اختر موقعك</h3>
    <div id="map"></div>
    <button class="btn" onclick="closeMap()">إغلاق</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let map, marker;

function openMap() {
  document.getElementById('overlay').style.display = 'block';
  document.getElementById('map').style.display = 'block';

  if (!map) {
    map = L.map('map').setView([24.7136, 46.6753], 10); // الرياض افتراضيًا
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
    }).addTo(map);

    map.on('click', function(e) {
      if(marker) map.removeLayer(marker);
      marker = L.marker(e.latlng).addTo(map);
      // استدعاء API لتحويل الاحداثيات إلى اسم المدينة والحي
      fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e.latlng.lat}&lon=${e.latlng.lng}&accept-language=ar`)
      .then(response => response.json())
      .then(data => {
        let address = data.address;
        document.getElementById('city').value = address.city || address.town || address.village || "";
        document.getElementById('district').value = address.suburb || address.neighbourhood || address.city_district || "";
        closeMap();
      });
    });
  }
}

function closeMap() {
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('map').style.display = 'none';
}
</script>
</body>
</html>
