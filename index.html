<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© ÙˆØ§Ù„Ø­ÙŠ ÙˆØ§Ù„Ø´Ø§Ø±Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (Google Maps)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { background:#888; font-family: Tahoma, Arial; }
    #map { height: 400px; display:none; margin-bottom: 15px;}
    #overlay { position: fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); display:none; z-index: 1000;}
    #popup { background:white; padding:20px; border-radius:15px; width:470px; margin:80px auto; position:relative; box-shadow: 0 2px 20px rgba(0,0,0,.15);}
    .field { margin: 8px 0; }
    .btn { padding:10px 20px; background:#2e8b57; color:white; border:none; border-radius:5px; cursor:pointer; margin:3px; }
    input[type="text"] { width:210px; padding:8px; border-radius:4px; border:1px solid #aaa;}
    h2, h3 { margin-top: 25px; }
    #popup h3 { margin: 0 0 14px 0; text-align: right;}
    .popup-buttons { text-align:right; margin-bottom:8px;}
  </style>
</head>
<body dir="rtl">

<h2>ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© ÙˆØ§Ù„Ø­ÙŠ ÙˆØ§Ù„Ø´Ø§Ø±Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</h2>
<div class="field">
  <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</label>
  <input id="city" type="text" readonly>
</div>
<div class="field">
  <label>Ø§Ø³Ù… Ø§Ù„Ø­ÙŠ:</label>
  <input id="district" type="text" readonly>
</div>
<div class="field">
  <label>Ø§Ø³Ù… Ø§Ù„Ø´Ø§Ø±Ø¹:</label>
  <input id="street" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø´Ø§Ø±Ø¹ Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¸Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§">
</div>
<button class="btn" onclick="openMap()">Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>

<div id="overlay">
  <div id="popup">
    <h3>Ø§Ø®ØªØ± Ù…ÙˆÙ‚Ø¹Ùƒ</h3>
    <div class="popup-buttons">
      <button class="btn" onclick="locateMe()">Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
      <button class="btn" onclick="closeMap()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div id="map"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let map, marker;

// ğŸ”‘ Ø¶Ø¹ Ù…ÙØªØ§Ø­ Google Maps Geocoding API Ù‡Ù†Ø§:
const GOOGLE_MAPS_API_KEY = "AIzaSyBZByJv1xc_9fvKfVjdcCfXWlhRcNM9_vE"; // Ø¶Ø¹ Ù…ÙØªØ§Ø­Ùƒ Ù‡Ù†Ø§

function openMap() {
  document.getElementById('overlay').style.display = 'block';
  document.getElementById('map').style.display = 'block';

  if (!map) {
    map = L.map('map').setView([24.7136, 46.6753], 12); // Ø§Ù„Ø±ÙŠØ§Ø¶ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
    }).addTo(map);

    map.on('click', function(e) {
      setMarkerAndAddress(e.latlng.lat, e.latlng.lng, true);
    });
  }
}

function setMarkerAndAddress(lat, lng, closeAfter=true) {
  if(marker) map.removeLayer(marker);
  marker = L.marker([lat, lng]).addTo(map);
  map.setView([lat, lng], 16);

  // Google Maps Geocoding API
  const url = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&language=ar&key=${GOOGLE_MAPS_API_KEY}`;
  fetch(url)
    .then(response => response.json())
    .then(data => {
      let city = "";
      let district = "";
      let street = "";

      if (data.results && data.results.length > 0) {
        // Ù†Ø¨Ø­Ø« ÙÙŠ ÙƒÙ„ address_components ÙˆÙ†Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
        let components = data.results[0].address_components;
        components.forEach(comp => {
          if (comp.types.includes("locality")) city = comp.long_name;
          if (comp.types.includes("administrative_area_level_2") && !city) city = comp.long_name;
          if (comp.types.includes("sublocality") || comp.types.includes("sublocality_level_1")) district = comp.long_name;
          if (comp.types.includes("route")) street = comp.long_name;
        });
      }

      document.getElementById('city').value = city;
      document.getElementById('district').value = district;
      document.getElementById('street').value = street;
      if(closeAfter) closeMap();
    });
}

function locateMe() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      setMarkerAndAddress(position.coords.latitude, position.coords.longitude, true);
    }, function(error) {
      alert('ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­.');
    });
  } else {
    alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ.');
  }
}

function closeMap() {
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('map').style.display = 'none';
}
</script>
</body>
</html>
