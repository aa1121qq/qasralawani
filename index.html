<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>TomTom Reverse Geocoding - بيانات أصلية</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { background:#888; font-family: Tahoma, Arial; }
    #map { height: 400px; width: 100%; display:none; margin-bottom: 15px;}
    #overlay {
      position: fixed; left:0; top:0; width:100vw; height:100vh;
      background:rgba(0,0,0,0.5); display:none; z-index: 1000;
    }
    #popup {
      background:white; padding:20px; border-radius:15px;
      width:470px; margin:80px auto; position:relative;
      box-shadow: 0 2px 20px rgba(0,0,0,.15);
    }
    .field { margin: 8px 0; }
    .btn {
      padding:10px 20px; background:#2e8b57; color:white;
      border:none; border-radius:5px; cursor:pointer; margin:3px;
    }
    input[type="text"] {
      width:210px; padding:8px; border-radius:4px; border:1px solid #aaa;
    }
    h2, h3 { margin-top: 25px; }
    #popup h3 { margin: 0 0 14px 0; text-align: right;}
    .popup-buttons { text-align:right; margin-bottom:8px;}
    textarea { width:98%; min-height:80px; margin-top:8px; }
  </style>
</head>
<body dir="rtl">

<h2>بيانات TomTom الأصلية</h2>
<div class="field">
  <label>المدينة (من TomTom):</label>
  <input id="city" type="text" readonly>
</div>
<div class="field">
  <label>الحي (من TomTom):</label>
  <input id="district" type="text" readonly>
</div>
<div class="field">
  <label>الشارع (من TomTom):</label>
  <input id="street" type="text" readonly>
</div>
<button class="btn" onclick="openMap()">حدد موقعك على الخريطة</button>

<div id="overlay">
  <div id="popup">
    <h3>اختر موقعك</h3>
    <div class="popup-buttons">
      <button class="btn" onclick="locateMe()">حدد موقعي الحالي</button>
      <button class="btn" onclick="closeMap()">إغلاق</button>
    </div>
    <div id="map"></div>
    <textarea id="raw_address" readonly></textarea>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let map = null, marker = null;
const TOMTOM_API_KEY = "5UrN1gCebJS4OwrY89BvUhyPzLO3QpvF"; // ضع مفتاح TomTom هنا

function openMap() {
  document.getElementById('overlay').style.display = 'block';
  document.getElementById('map').style.display = 'block';

  setTimeout(function() {
    if (!map) {
      map = L.map('map').setView([24.7136, 46.6753], 12); // الرياض افتراضيًا
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
      }).addTo(map);

      map.on('click', function(e) {
        setMarkerAndAddress(e.latlng.lat, e.latlng.lng);
      });
    }
    map.invalidateSize();
  }, 200);
}

function setMarkerAndAddress(lat, lng) {
  if (marker) map.removeLayer(marker);
  marker = L.marker([lat, lng]).addTo(map);
  map.setView([lat, lng], 16);

  fetch(`https://api.tomtom.com/search/2/reverseGeocode/${lat},${lng}.json?key=${TOMTOM_API_KEY}`)
    .then(res => res.json())
    .then(data => {
      let address = {};
      if (data.addresses && data.addresses.length > 0 && data.addresses[0].address) {
        address = data.addresses[0].address;
      }
      // عرض البيانات الأصلية فقط من TomTom بدون تحويل أو ترجمة
      document.getElementById('city').value = address.municipality || address.localName || address.city || "";
      document.getElementById('district').value = address.municipalitySubdivision || address.suburb || address.neighbourhood || "";
      document.getElementById('street').value = address.streetName || address.street || "";

      // كل الرد كامل في textarea
      document.getElementById('raw_address').value = JSON.stringify(address, null, 2);
    });
}

function locateMe() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      setMarkerAndAddress(position.coords.latitude, position.coords.longitude);
    }, function(error) {
      alert('تعذر الحصول على موقعك الحالي. الرجاء السماح للوصول للموقع من إعدادات المتصفح.');
    });
  } else {
    alert('المتصفح لا يدعم تحديد الموقع الجغرافي.');
  }
}

function closeMap() {
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('map').style.display = 'none';
}
</script>
</body>
</html>
